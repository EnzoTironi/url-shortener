# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build iam`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t iam`.
FROM node:18-alpine AS builder

WORKDIR /app

# Copy package files first
COPY package*.json ./
COPY nx.json ./
COPY tsconfig*.json ./

# Install dependencies and generate Prisma client
RUN npm ci

COPY . .

RUN npx prisma generate --schema=./libs/prisma-iam/src/prisma/schema.prisma 
RUN npx prisma generate --schema=./libs/prisma-url/src/prisma/schema.prisma 
RUN npx nx build iam

# Final stage
FROM node:18-alpine

# Copy built app
COPY --from=builder /app/dist/apps/iam .
COPY --from=builder /app/dist/apps/iam/package*.json .

# Copy prisma schema and client
COPY --from=builder /app/node_modules/@prisma/client/ ./node_modules/@prisma/client/
COPY --from=builder /app/libs/prisma-iam/src/prisma/ ./prisma/


# Install production dependencies in the app directory
RUN npm install --omit=dev

EXPOSE 3001

# Change CMD to run migrations before starting
CMD ["/bin/sh", "-c", "npx prisma migrate deploy --schema=./prisma/schema.prisma && node main.js"]
