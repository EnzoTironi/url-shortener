# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build iam`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t iam`.
FROM node:18-alpine AS builder

WORKDIR /app

# Copy entire workspace configuration
COPY package*.json ./
COPY nx.json ./
COPY tsconfig*.json ./

# Install all dependencies including workspace packages and generate Prisma clients
RUN npm ci

# Copy source code for libs and apps
COPY libs/ ./libs/
COPY apps/ ./apps/
COPY . .

RUN npx prisma generate --schema=./libs/prisma-iam/src/prisma/schema.prisma 
RUN npx prisma generate --schema=./libs/prisma-url/src/prisma/schema.prisma 
RUN npx nx build url-shortener --verbose

# Final stage
FROM node:18-alpine

WORKDIR /app

# Copy built app
COPY --from=builder /app/dist/apps/url-shortener ./dist/apps/url-shortener


COPY --from=builder /app/dist/apps/url-shortener/package*.json .

# Copy prisma schema and client
COPY --from=builder /app/node_modules/@prisma/client/ ./node_modules/@prisma/client/
COPY --from=builder /app/libs/prisma-url/src/prisma/ ./prisma/

# Install production dependencies
RUN npm install --omit=dev --verbose

EXPOSE 3002

# Change CMD to run migrations before starting
CMD ["/bin/sh", "-c", "npx prisma migrate deploy --schema=./prisma/schema.prisma && node dist/apps/url-shortener/main.js"]
