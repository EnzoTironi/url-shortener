# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build iam`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 -t iam`.
FROM node:18-alpine AS builder

WORKDIR /app

# Copy entire workspace configuration
COPY package*.json ./
COPY nx.json ./
COPY tsconfig*.json ./

# Copy source code for libs and apps
COPY libs/ ./libs/
COPY apps/ ./apps/

COPY . .

# Install all dependencies including workspace packages
RUN npm ci

# Generate Prisma clients
RUN npx prisma generate --schema=./libs/prisma-iam/src/prisma/schema.prisma && \
    npx prisma generate --schema=./libs/prisma-url/src/prisma/schema.prisma

# Build the app with Nx (this will include the libs in the build)
RUN npx nx build url-shortener --verbose

# Final stage
FROM node:18-alpine

WORKDIR /app

# Copy built app
COPY --from=builder /app/dist/apps/url-shortener ./dist/apps/url-shortener
COPY --from=builder /app/node_modules/@prisma/client/ ./node_modules/@prisma/client/

COPY --from=builder /app/dist/apps/url-shortener/package*.json .
# Copy the logger package to the correct location relative to the app
COPY --from=builder /app/node_modules/pino-pretty/ ./node_modules/pino-pretty/

# Install production dependencies
RUN npm install --omit=dev --verbose

EXPOSE 3002

CMD ["node", "dist/apps/url-shortener/main.js"]
